#!/bin/bash
VAULT_EXEC=./.bin.db/vault

export VAULT_ADDR="{{ secrets.vault.host }}"
{% if secrets.vault.tls.enabled %}
export VAULT_CACERT={{ dbctl_vault_ca_cert_file }}
export VAULT_CLIENT_CERT={{ dbctl_vault_cert_file }}
export VAULT_CLIENT_KEY={{ dbctl_vault_key_file }}
export VAULT_TOKEN={{ dbctl_vault_token }}
{% endif %}

CURRENT_DIRECTORY=$(pwd)
mkdir -p $CURRENT_DIRECTORY/.credentials
CREDENTIAL_FILE=$CURRENT_DIRECTORY/.credentials/{{ db_role_name }}.yaml

# v11-alt read - for Vault > 1.1.0
# echo "==> v11-alt read - for Vault > 1.1.0"
# $VAULT_EXEC read -format=yaml {{ db_identifier_path }}/creds/{{ db_role_name }} > $CREDENTIAL_FILE

# v11-read - for Vault > 1.1.0
echo "==> v11-read - for Vault > 1.1.0"
$VAULT_EXEC read -format=yaml {{ v11_db_identifier_path }}/creds/{{ db_role_name }} > $CREDENTIAL_FILE

# v10-read - for Vault < 1.1.0
# echo "==> v10-read - for Vault < 1.1.0"
# $VAULT_EXEC read -format=yaml {{ v10_db_identifier_path_namespace }}/creds/{{ v10_db_identifier_path_key }}-migrations > $CREDENTIAL_FILE

cat $CREDENTIAL_FILE
