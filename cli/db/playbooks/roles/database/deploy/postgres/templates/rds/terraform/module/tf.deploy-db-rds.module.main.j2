resource "aws_security_group" "rds_db_security_group" {
  name        = "{{ db_identifier }}"
  description = "SecurityGroup-{{ db_identifier }}"
  vpc_id      = "${var.vpc_id}"

  tags {
    Name = "{{ db_identifier }}"
    ResourceType = "SecurityGroup"
    Organization = "${var.db_organization}"
    Team = "${var.db_team}"
    Product = "${var.db_product}"
    Environment = "${var.db_environment}"
    VPC = "${var.vpc_name}"
    VPCPrefix = "${var.vpc_prefix}"
  }
}

resource "aws_security_group_rule" "rds_db_security_group_ingress" {
  type            = "ingress"
  from_port       = 0
  to_port         = 65535
  protocol        = "tcp"
  cidr_blocks     = ["0.0.0.0/0"]
  security_group_id = "${aws_security_group.rds_db_security_group.id}"
}

resource "aws_security_group_rule" "rds_db_security_group_egress" {
  type            = "egress"
  from_port       = 0
  to_port         = 65535
  protocol        = "tcp"
  cidr_blocks     = ["0.0.0.0/0"]
  security_group_id = "${aws_security_group.rds_db_security_group.id}"
}

resource "aws_db_subnet_group" "rds_db_subnet_group" {
  name       = "{{ db_identifier }}"
  subnet_ids = ["${var.vpc_subnet_ids}"]

  tags {
    Name = "{{ db_identifier }}"
    ResourceType = "RDSSubnetGroup"
    Organization = "${var.db_organization}"
    Team = "${var.db_team}"
    Product = "${var.db_product}"
    Environment = "${var.db_environment}"
  }
}

resource "aws_db_parameter_group" "rds_db_parameter_group" {
  name   = "{{ db_identifier }}"
  family = "postgres10"
  tags {
    Name = "{{ db_identifier }}"  
    ResourceType = "RDSParameterGroup"
    Organization = "${var.db_organization}"
    Team = "${var.db_team}"
    Product = "${var.db_product}"
    Environment = "${var.db_environment}"
  }
}

resource "aws_db_instance" "rds_db_instance" {
  identifier                = "${var.identifier}"
  instance_class            = "${var.rds_db_instance_class}"
  engine                    = "${var.rds_db_instance_engine}"
  engine_version            = "${var.rds_db_instance_engine_version}"
  name                      = "${var.rds_db_instance_database_name}"
  username                  = "${var.rds_db_instance_username}"
  password                  = "${var.rds_db_instance_password}"
  allocated_storage         = "${var.rds_db_instance_storage_size}"
  parameter_group_name      = "${aws_db_parameter_group.rds_db_parameter_group.name}"
  db_subnet_group_name      = "${aws_db_subnet_group.rds_db_subnet_group.name}"
  final_snapshot_identifier = "{{ db_identifier }}-snapshot"
  vpc_security_group_ids = ["${aws_security_group.rds_db_security_group.id}"]
  tags {
    Name = "${var.rds_db_instance_database_name}"
    ResourceType = "RDSDatabase-${var.rds_db_instance_engine}-${var.rds_db_instance_engine_version}"
    Organization = "${var.db_organization}"
    Team = "${var.db_team}"
    Product = "${var.db_product}"
    Environment = "${var.db_environment}"
    VPC = "${var.vpc_name}"
    VPCPrefix = "${var.vpc_prefix}"
  }
  depends_on = [
    "aws_db_parameter_group.rds_db_parameter_group", 
    "aws_db_subnet_group.rds_db_subnet_group", 
    "aws_security_group.rds_db_security_group"]
}