- name: Checking variables - DB Provider
  debug:
    var: db_provider

- name: Checking variables - DB Name
  debug:
    var: db_name

- name: Checking variables - DB Environment
  debug:
    var: db_environment

- name: Checking variables - DB Directory
  debug:
    var: db_directory

- name: Checking RDS Specification
  debug:
    var: db.rds

- name: Ensure directory for terraform template
  file:
    path: "{{ db_directory }}/rds"
    state: "directory"

- name: "Generate Random DB Password with length: {{ db.rds.db_provider_root_credential.password_length }}"
  shell: "pwgen -s {{ db.rds.db_provider_root_credential.password_length }} 1"
  register: db_generated_password_output

- name: Register
  set_fact:
    db_generated_password: "{{ db_generated_password_output.stdout_lines[0] }}"
    db_generated_user: "{{ db_name }}_{{ db.rds.db_provider_root_credential.username }}"

- name: Constructing DB RDS Terraform Template - main.tf
  template: 
    src: "rds/terraform/tf.deploy-db-rds.main.j2"
    dest: "{{ db_directory }}/main.tf"

- name: Constructing DB RDS Terraform Template - rds/main.tf
  template: 
    src: "rds/terraform/module/tf.deploy-db-rds.module.main.j2"
    dest: "{{ db_directory }}/rds/main.tf"

- name: Constructing DB RDS Terraform Template - rds/outputs.tf
  template: 
    src: "rds/terraform/module/tf.deploy-db-rds.module.outputs.j2"
    dest: "{{ db_directory }}/rds/outputs.tf"

- name: Constructing DB RDS Terraform Template - rds/variables.tf
  template: 
    src: "rds/terraform/module/tf.deploy-db-rds.module.variables.j2"
    dest: "{{ db_directory }}/rds/variables.tf"

- name: Constructing DB RDS tfapply
  template: 
    src: "rds/terraform/tfapply.j2"
    dest: "{{ db_directory }}/tfapply"
    mode: 0755

- name: Constructing DB RDS tfdestroy
  template: 
    src: "rds/terraform/tfdestroy.j2"
    dest: "{{ db_directory }}/tfdestroy"
    mode: 0755

- name: Constructing DB RDS generated-password.tfvars
  template:
    src: "rds/terraform/generated-password.tfvars.j2"
    dest: "{{ db_directory }}/.generated-password.tfvars"

- name: Constructing Secrets Management Flow - vault
  template:
    src: rds/secrets/creds-upload-vault.j2
    dest: "{{ db_directory }}/.creds-upload-vault"
    mode: 0755

- name: Constructing Secrets Management Flow - aws-sm
  template:
    src: rds/secrets/creds-upload-aws-sm.j2
    dest: "{{ db_directory }}/.creds-upload-aws-sm"
    mode: 0755