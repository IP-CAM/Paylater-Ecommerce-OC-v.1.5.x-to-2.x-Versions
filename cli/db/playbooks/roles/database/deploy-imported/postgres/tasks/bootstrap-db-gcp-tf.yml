- name: Checking variables - DB Provider
  debug:
    var: db_provider

- name: Checking variables - DB Name
  debug:
    var: db_name

- name: Checking variables - DB Environment
  debug:
    var: db_environment

- name: Checking variables - DB Directory
  debug:
    var: db_directory

- name: Checking gcp Specification
  debug:
    var: db.gcp

- name: Ensure directory for synchronization
  file:
    path: "{{ db_directory }}/gcp"
    state: "directory"

- name: "Generate Random DB Password with length: {{ db.gcp.db_provider_root_credential.password_length }}"
  shell: "pwgen -s {{ db.gcp.db_provider_root_credential.password_length }} 1"
  register: db_generated_password_output

- name: Register
  set_fact:
    db_generated_password: "{{ db_generated_password_output.stdout_lines[0] }}"
    db_generated_user: "{{ db_name }}_{{ db.gcp.db_provider_root_credential.username }}"
    db_generated_migration_user: "{{ db_name }}_migrations"

- name: Constructing DB GCP Terraform Template - main.tf
  template:
    src: "gcp/terraform/tf.bootstrap-db-gcp.main.j2"
    dest: "{{ db_directory }}/main.tf"

- name: Constructing DB GCP Terraform Template - gcp/main.tf
  template:
    src: "gcp/terraform/module/tf.bootstrap-db-gcp.module.main.j2"
    dest: "{{ db_directory }}/gcp/main.tf"

- name: Constructing DB GCP Terraform Template - gcp/outputs.tf
  template:
    src: "gcp/terraform/module/tf.bootstrap-db-gcp.module.outputs.j2"
    dest: "{{ db_directory }}/gcp/outputs.tf"

- name: Constructing DB GCP Terraform Template - gcp/variables.tf
  template:
    src: "gcp/terraform/module/tf.bootstrap-db-gcp.module.variables.j2"
    dest: "{{ db_directory }}/gcp/variables.tf"

- name: Constructing DB GCP tfapply
  template:
    src: "gcp/terraform/tfapply.j2"
    dest: "{{ db_directory }}/tfapply"
    mode: 0755

- name: Constructing DB GCP tfdestroy
  template:
    src: "gcp/terraform/tfdestroy.j2"
    dest: "{{ db_directory }}/tfdestroy"
    mode: 0755

- name: Constructing DB GCP generated-password.tfvars
  template:
    src: "gcp/terraform/generated-password.tfvars.j2"
    dest: "{{ db_directory }}/.generated-password.tfvars"

- name: Constructing DB PGPASSWORD=generated_password
  template:
    src: "gcp/sql/PGPASSWORD.j2"
    dest: "{{ db_directory }}/PGPASSWORD"

- name: Preparing SQL db directory
  file:
    path: "{{ db_directory }}/sql"
    state: directory

- name: Preparing db __roles__/migrations directory
  file:
    path: "{{ db_directory }}/sql/__roles__/migrations/"
    state: directory

- name: Constructing DB SQL creation script
  template:
    src: gcp/sql/create-db.sql.j2
    dest: "{{ db_directory }}/sql/create-db.sql"

- name: Constructing __roles__/migrations/creation.sql
  template:
    src: "gcp/sql/__roles__/migrations/creation.sql.j2"
    dest: "{{ db_directory }}/sql/__roles__/migrations/creation.sql"

- name: Constructing Secrets Management Flow - vault
  template:
    src: gcp/secrets/creds-upload-vault.j2
    dest: "{{ db_directory }}/.creds-upload-vault"
    mode: 0755